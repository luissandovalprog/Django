{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    {% if not user.puede_ver_todos_partos and user.rol.nombre != 'Administrativo' %}
    <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
        </svg>
        <div>
            <strong>Turno Activo</strong>
            <p>Solo visualiza pacientes asignados a su turno según Ley 20.584</p>
        </div>
    </div>
    {% endif %}

    <!-- Search Bar -->
    <div class="search-container">
        <form method="get" action="{% url 'core:dashboard' %}">
            <div class="search-input-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" 
                       name="busqueda" 
                       class="search-input" 
                       placeholder="Buscar por RUT de madre, nombre o ID del RN..."
                       value="{{ busqueda_query|default:'' }}">
            </div>
        </form>
    </div>

    {% if user.rol.nombre != 'Admin Sistema' %}
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-content">
                <h3>Madres Registradas</h3>
                <p>{{ total_madres }}</p>
                <span style="font-size: 13px; color: var(--gray-500);">En mi turno</span>
            </div>
            <div class="stat-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <h3>Partos Totales</h3>
                <p>{{ total_partos }}</p>
                <span style="font-size: 13px; color: var(--gray-500);">En mi turno</span>
            </div>
            <div class="stat-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 32 32" fill="currentColor">
                    <path d="M27.4,13.3c-1-3.2-3.4-5.8-6.4-7.2c-0.4-1.4-1.2-2.6-2.4-3.6c-0.4-0.3-1.1-0.3-1.4,0.2c-0.3,0.4-0.3,1.1,0.2,1.4 c2,1.6,2.6,4.4,1.4,6.7c-1,2-3.5,2.7-5.5,1.7c-1.5-0.8-2.1-2.6-1.3-4.1c0.3-0.5,0.7-0.9,1.3-1.1c0.6-0.2,1.2-0.1,1.7,0.2 c0.4,0.2,0.7,0.5,0.8,0.9c0.1,0.4,0.1,0.8-0.1,1.2c-0.3,0.5-0.1,1.1,0.4,1.4c0.5,0.3,1.1,0.1,1.4-0.4c0.4-0.8,0.5-1.8,0.3-2.7 s-0.9-1.7-1.8-2.1c-1-0.5-2.2-0.6-3.2-0.3c-0.4,0.1-0.8,0.3-1.1,0.6c-3.3,1.3-5.8,4-6.9,7.4C3.1,13.8,2,15.3,2,17 c0,1.7,1.1,3.2,2.6,3.8C6.2,25.6,10.8,29,16,29s9.8-3.4,11.4-8.3c1.5-0.6,2.6-2.1,2.6-3.8C30,15.3,28.9,13.8,27.4,13.3z M12,16 c0-0.6,0.4-1,1-1s1,0.4,1,1v2c0,0.6-0.4,1-1,1s-1-0.4-1-1V16z M15,26c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3S16.7,26,15,26z M20,18 c0,0.6-0.4,1-1,1s-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1V18z"/>
                </svg>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <h3>Partos Hoy</h3>
                <p>{{ partos_hoy }}</p>
                <span style="font-size: 13px; color: var(--gray-500);">Últimas 24h</span>
            </div>
            <div class="stat-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <h3>RN Hospitalizados</h3>
                <p>{{ total_recien_nacidos }}</p>
                <span style="font-size: 13px; color: var(--gray-500);">Activos</span>
            </div>
            <div class="stat-icon cyan">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Births Table -->
    {% if user.puede_ver_todos_partos or user.rol.nombre == 'Matrona Clínica' %}
<div class="card">
    <h2 class="card-header">Recién Nacidos Hospitalizados</h2>
    
    {% if not ultimos_partos %}
        <p style="text-align: center; color: var(--gray-500); padding: 40px 0;">
            No hay partos registrados que coincidan con su búsqueda.
        </p>
    {% else %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>ID Recién Nacido</th>
                    <th>Madre</th>
                    <th>RUT Madre</th>
                    <th>Fecha Ingreso</th>
                    <th>Días</th>
                    <th>Tipo</th>
                    <th>Peso</th>
                    <th>APGAR</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for parto in ultimos_partos %}
                {% with parto.recien_nacidos.first as rn %}
                <tr>
                    <td style="font-weight: 600;">{{ rn.rut_provisorio|default_if_none:parto.id|truncatechars:15 }}</td>
                    <td>{{ parto.madre.nombre_descifrado|default:"N/A" }}</td>
                    <td>{{ parto.madre.get_rut|default:"N/A" }}</td>
                    <td>{{ parto.fecha_parto|date:"d-m-Y H:i" }}</td>
                    <td>
                        {% now "U" as current_timestamp %}
                        {% with parto.fecha_parto|date:"U" as parto_timestamp %}
                            {% with dias_hospitalizacion=current_timestamp|add:"-"|add:parto_timestamp %}
                                {% widthratio dias_hospitalizacion 86400 1 as dias %}
                                <span class="badge {% if dias <= 3 %}badge-green{% elif dias <= 7 %}badge-yellow{% else %}badge-red{% endif %}">
                                    {{ dias }} día{{ dias|pluralize }}
                                </span>
                            {% endwith %}
                        {% endwith %}
                    </td>
                    <td>
                        <span class="badge {% if 'Cesárea' in parto.tipo_parto %}badge-yellow{% else %}badge-green{% endif %}">
                            {{ parto.tipo_parto }}
                        </span>
                    </td>
                    <td>{{ rn.peso_gramos|default_if_none:"N/A" }}g</td>
                    <td>{{ rn.apgar_1_min|default_if_none:"-" }}/{{ rn.apgar_5_min|default_if_none:"-" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'core:parto_detail' parto.pk %}" class="btn-icon blue" title="Ver detalle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </a>
                            <a href="{% url 'reportes:generar_brazalete_pdf' parto.pk %}" class="btn-icon green" title="Imprimir brazalete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 6 2 18 2 18 9"/>
                                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                                    <rect x="6" y="14" width="12" height="8"/>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endif %}

    <!-- Mothers without Birth Record -->
    {% if user.puede_crear_partos %}
<div class="card">
    <h3 class="card-header">Madres sin Parto Registrado (Mi Turno)</h3>
    {% if not madres_sin_parto %}
    <p style="text-align: center; color: var(--gray-500); padding: 20px 0;">
        Todas las madres de este turno tienen partos registrados
    </p>
    {% else %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>NOMBRE</th>
                    <th>RUT</th>
                    <th>EDAD</th>
                    <th>DIRECCIÓN</th>
                    <th>PREVISIÓN</th>
                    <th>ACCIÓN</th>
                </tr>
            </thead>
            <tbody>
                {% for madre in madres_sin_parto %}
                <tr>
                    <!-- NOMBRE → Nombre completo descifrado -->
                    <td style="font-weight: 600;">{{ madre.nombre_descifrado|default:"N/A" }}</td>
                    
                    <!-- RUT → RUT descifrado -->
                    <td>{{ madre.get_rut|default:"N/A" }}</td>
                    
                    <!-- EDAD → Edad calculada en años -->
                    <td>
                        {% if madre.fecha_nacimiento %}
                            {% load tz %}
                            {% now "Y" as current_year %}
                            {% widthratio madre.fecha_nacimiento|date:"Y" 1 -1 as birth_year_negative %}
                            {% widthratio current_year 1 1 as current_year_int %}
                            {{ current_year_int|add:birth_year_negative }} años
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    
                    <!-- DIRECCIÓN → Dirección física -->
                    <td>{{ madre.direccion|default:"Sin dirección"|truncatewords:8 }}</td>
                    
                    <!-- PREVISIÓN → Badge de previsión -->
                    <td>
                        <span class="badge badge-blue">{{ madre.prevision|default:"Sin Previsión" }}</span>
                    </td>
                    
                    <!-- ACCIÓN → Botón Registrar Parto -->
                    <td>
                        <a href="{% url 'core:registrar_parto_completo' madre.pk %}" class="btn btn-success">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Registrar Parto
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endif %}

</div>
{% endblock %}