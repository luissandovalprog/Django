{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="animacion-entrada">
    
    {% if not user.puede_ver_todos_partos and user.rol.nombre != 'Administrativo' %}
    <div class="mb-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-lg">
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <div>
                <p class="font-semibold">Turno Activo</p>
                <p class="text-sm">Solo visualiza pacientes asignados a su turno. (Ley 20.584)</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="tarjeta mb-6">
        <form method="get" action="{% url 'core:dashboard' %}">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <input
                    type="text"
                    name="busqueda"
                    class="input pl-10"
                    placeholder="Buscar por RUT de madre, Ficha Clínica o ID del RN..."
                    value="{{ busqueda_query|default:'' }}"
                />
            </div>
        </form>
    </div>

    {% if user.rol.nombre != 'Admin Sistema' %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="tarjeta hover:shadow-xl transition-shadow">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Madres</p>
                    <p class="text-3xl font-bold text-blue-600">{{ total_madres }}</p>
                </div>
                <svg class="h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
        </div>
        <div class="tarjeta hover:shadow-xl transition-shadow">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Partos</p>
                    <p class="text-3xl font-bold text-green-600">{{ total_partos }}</p>
                </div>
                
                <svg class="h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor">
                    <path d="M27.4,13.3c-1-3.2-3.4-5.8-6.4-7.2c-0.4-1.4-1.2-2.6-2.4-3.6c-0.4-0.3-1.1-0.3-1.4,0.2c-0.3,0.4-0.3,1.1,0.2,1.4 c2,1.6,2.6,4.4,1.4,6.7c-1,2-3.5,2.7-5.5,1.7c-1.5-0.8-2.1-2.6-1.3-4.1c0.3-0.5,0.7-0.9,1.3-1.1c0.6-0.2,1.2-0.1,1.7,0.2 c0.4,0.2,0.7,0.5,0.8,0.9c0.1,0.4,0.1,0.8-0.1,1.2c-0.3,0.5-0.1,1.1,0.4,1.4c0.5,0.3,1.1,0.1,1.4-0.4c0.4-0.8,0.5-1.8,0.3-2.7 s-0.9-1.7-1.8-2.1c-1-0.5-2.2-0.6-3.2-0.3c-0.4,0.1-0.8,0.3-1.1,0.6c-3.3,1.3-5.8,4-6.9,7.4C3.1,13.8,2,15.3,2,17 c0,1.7,1.1,3.2,2.6,3.8C6.2,25.6,10.8,29,16,29s9.8-3.4,11.4-8.3c1.5-0.6,2.6-2.1,2.6-3.8C30,15.3,28.9,13.8,27.4,13.3z M12,16 c0-0.6,0.4-1,1-1s1,0.4,1,1v2c0,0.6-0.4,1-1,1s-1-0.4-1-1V16z M15,26c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3S16.7,26,15,26z M20,18 c0,0.6-0.4,1-1,1s-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1V18z"></path>
                </svg>
                
            </div>
        </div>
        <div class="tarjeta hover:shadow-xl transition-shadow">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500">Recién Nacidos</p>
                    <p class="text-3xl font-bold text-indigo-600">{{ total_recien_nacidos }}</p>
                </div>
                <svg class="h-12 w-12 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
        </div>
        <div class="tarjeta hover:shadow-xl transition-shadow">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500">Partos Hoy</p>
                    <p class="text-3xl font-bold text-yellow-600">{{ partos_hoy }}</p>
                </div>
                <svg class="h-12 w-12 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </div>
        </div>
    </div>
    {% endif %}

    {% if user.puede_ver_todos_partos or user.rol.nombre == 'Matrona Clínica' %}
    <div class="tarjeta">
        <h2 class="text-2xl font-bold mb-4">Últimos Partos Registrados</h2>
        {% if not ultimos_partos %}
            <p class="text-center text-gray-500 py-6">No hay partos registrados que coincidan con su búsqueda.</p>
        {% else %}
        <div class="overflow-x-auto">
            <table class="tabla">
                <thead>
                    <tr>
                        <th>ID Recién Nacido</th>
                        <th>Madre</th>
                        <th>RUT Madre</th>
                        <th>Fecha/Hora</th>
                        <th>Tipo</th>
                        <th>Peso</th>
                        <th>APGAR</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for parto in ultimos_partos %}
                    {% with parto.recien_nacidos.first as rn %}
                    <tr>
                        <td class="font-medium text-gray-900">{{ rn.rut_provisorio|default_if_none:parto.id|truncatechars:15 }}</td>
                        <td>{{ parto.madre.nombre_descifrado|default:"N/A" }}</td>
                        <td>{{ parto.madre.rut_descifrado|default:"N/A" }}</td>
                        <td>{{ parto.fecha_parto|date:"d/m/Y H:i" }}</td>
                        <td>
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if 'Cesárea' in parto.tipo_parto %} bg-yellow-100 text-yellow-800
                                {% else %} bg-green-100 text-green-800 {% endif %}">
                                {{ parto.tipo_parto }}
                            </span>
                        </td>
                        <td>{{ rn.peso_gramos|default_if_none:"N/A" }}g</td>
                        <td>{{ rn.apgar_1_min|default_if_none:"-" }}/{{ rn.apgar_5_min|default_if_none:"-" }}</td>
                        <td class="flex items-center gap-2">
                            <a href="{% url 'core:parto_detail' parto.pk %}" class="boton boton-primario !p-2" title="Ver Detalle">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </a>
                            {% if user.puede_editar_partos %}
                            <a href="{% url 'core:parto_update' parto.pk %}" class="boton !p-2 bg-yellow-500 hover:bg-yellow-600 text-white" title="Editar Parto">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if user.rol.nombre == 'Administrativo' %}
    <div class="tarjeta mt-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Listado de Madres (Datos Demográficos)</h2>
            <div class="p-2 bg-yellow-100 text-yellow-800 rounded-lg">
                <p class="text-xs font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Sin acceso a datos clínicos (Ley 20.584)
                </p>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="tabla">
                <thead>
                    <tr>
                        <th>RUT</th>
                        <th>Nombre</th>
                        <th>Fecha Nacimiento</th>
                        <th>Previsión</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for madre in madres_qs %}
                    <tr>
                        <td class="font-medium text-gray-900">{{ madre.get_rut|default:"N/A" }}</td>
                        <td>{{ madre.get_nombre|default:"N/A" }}</td>
                        <td>{{ madre.fecha_nacimiento|date:"d/m/Y" }}</td>
                        <td>{{ madre.prevision|default:"N/A" }}</td>
                        <td class="flex items-center gap-2">
                            <a href="{% url 'core:madre_detail' madre.pk %}" class="boton !p-2 bg-indigo-600 hover:bg-indigo-700 text-white" title="Ver Información Demográfica">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </a>
                            <a href="{% url 'core:madre_update' madre.pk %}" class="boton !p-2 bg-yellow-500 hover:bg-yellow-600 text-white" title="Editar Datos Demográficos">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-6">No hay madres registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if user.puede_crear_partos %}
    <div class="tarjeta mt-6">
        <h3 class="text-xl font-bold mb-4">Madres sin Parto Registrado</h3>
        {% if not madres_sin_parto %}
        <p class="text-center text-gray-500 py-4">
            Todas las madres visibles tienen partos registrados.
        </p>
        {% else %}
        <div class="space-y-3">
            {% for madre in madres_sin_parto %}
            <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg">
                <div>
                    <p class="font-semibold text-gray-800">{{ madre.nombre_descifrado }}</p>
                    <p class="text-sm text-gray-600">
                        RUT: {{ madre.rut_descifrado }}
                    </p>
                </div>
                <a href="{% url 'core:parto_create' %}?madre_id={{ madre.pk }}" class="boton boton-secundario">
                    Registrar Parto
                </a>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}