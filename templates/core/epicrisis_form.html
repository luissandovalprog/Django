{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 1000px; margin: 0 auto;">
    <div class="card">
        <h2 class="card-header">{{ title }}</h2>

        <!-- Información de la madre -->
        <div style="background: #e0f2fe; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-900); margin: 0;">
                    Madre: {{ madre.nombre_descifrado }}
                </h3>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 14px; color: var(--gray-700); margin-top: 12px;">
                <div>
                    <strong>RUT:</strong> {{ madre.rut_descifrado }}
                </div>
                <div>
                    <strong>Tipo Parto:</strong> 
                    <span class="badge {% if 'Cesárea' in parto.tipo_parto %}badge-yellow{% else %}badge-green{% endif %}">
                        {{ parto.tipo_parto }}
                    </span>
                </div>
                <div>
                    <strong>Fecha:</strong> {{ parto.fecha_parto|date:"d/m/Y H:i" }}
                </div>
            </div>
        </div>

        <form method="post">
            {% csrf_token %}

            <!-- SECCIÓN 1: DATOS DE EPICRISIS -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--gray-200);">
                <h3 style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: var(--primary-blue);">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Datos de Epicrisis
                </h3>

                <div class="form-group">
                    <label for="{{ form.motivo_ingreso.id_for_label }}" class="form-label">
                        {{ form.motivo_ingreso.label }}
                    </label>
                    <input type="text" 
                           id="{{ form.motivo_ingreso.id_for_label }}" 
                           name="{{ form.motivo_ingreso.name }}"
                           class="form-input" 
                           placeholder="Ej: Trabajo de parto en fase activa"
                           value="{{ form.motivo_ingreso.value|default:'' }}">
                    <p class="form-hint">Razón principal del ingreso hospitalario</p>
                    {% if form.motivo_ingreso.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.motivo_ingreso.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.resumen_evolucion.id_for_label }}" class="form-label required">
                        {{ form.resumen_evolucion.label }}
                    </label>
                    <textarea id="{{ form.resumen_evolucion.id_for_label }}" 
                              name="{{ form.resumen_evolucion.name }}"
                              class="form-textarea" 
                              rows="4"
                              placeholder="Describa la evolución del paciente durante la hospitalización">{{ form.resumen_evolucion.value|default:'' }}</textarea>
                    <p class="form-hint">Descripción de la evolución del paciente durante la hospitalización</p>
                    {% if form.resumen_evolucion.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.resumen_evolucion.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.diagnostico_egreso.id_for_label }}" class="form-label required">
                        {{ form.diagnostico_egreso.label }}
                    </label>
                    <textarea id="{{ form.diagnostico_egreso.id_for_label }}" 
                              name="{{ form.diagnostico_egreso.name }}"
                              class="form-textarea" 
                              rows="3"
                              placeholder="Ej: Parto eutócico, puerperio fisiológico">{{ form.diagnostico_egreso.value|default:'' }}</textarea>
                    <p class="form-hint">Diagnóstico principal y secundarios al momento del egreso</p>
                    {% if form.diagnostico_egreso.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.diagnostico_egreso.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
                
                <!-- NUEVO: Selector de Diagnósticos CIE-10 -->
                <div class="form-group" style="margin-top: 20px; margin-bottom: 20px;">
                    <label class="form-label">Diagnósticos CIE-10</label>
                    <p class="form-hint" style="margin-bottom: 12px;">
                        Seleccione uno o más diagnósticos codificados CIE-10 aplicables al egreso
                    </p>
                    
                    <!-- Lista de diagnósticos con checkboxes -->
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: 6px; padding: 12px; background: #f9fafb;">
                        {% for diagnostico in form.diagnosticos_cie10.field.queryset %}
                        <div class="diagnostico-item">
                            <label style="display: flex; align-items: start; padding: 8px; margin-bottom: 4px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#e5e7eb'" 
                                   onmouseout="this.style.background='transparent'">
                                <input type="checkbox" 
                                       name="{{ form.diagnosticos_cie10.name }}" 
                                       value="{{ diagnostico.pk }}"
                                       style="margin-right: 10px; margin-top: 4px;"
                                       {% if diagnostico in form.diagnosticos_cie10.value %}checked{% endif %}>
                                <div style="flex: 1;">
                                    <strong style="color: var(--primary-blue); font-size: 13px;">{{ diagnostico.codigo }}</strong>
                                    <span style="color: var(--gray-700); font-size: 14px; display: block; margin-top: 2px;">{{ diagnostico.descripcion }}</span>
                                </div>
                            </label>
                        </div>
                        {% empty %}
                        <p style="text-align: center; color: var(--gray-500); font-size: 14px;">No hay diagnósticos CIE-10 disponibles</p>
                        {% endfor %}
                    </div>
                </div>


                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.condicion_egreso.id_for_label }}" class="form-label required">
                            {{ form.condicion_egreso.label }}
                        </label>
                        <select id="{{ form.condicion_egreso.id_for_label }}" 
                                name="{{ form.condicion_egreso.name }}"
                                class="form-select">
                            <option value="">Seleccione...</option>
                            <option value="buena" {% if form.condicion_egreso.value == "buena" %}selected{% endif %}>Buena</option>
                            <option value="regular" {% if form.condicion_egreso.value == "regular" %}selected{% endif %}>Regular</option>
                            <option value="grave" {% if form.condicion_egreso.value == "grave" %}selected{% endif %}>Grave</option>
                            <option value="fallecido" {% if form.condicion_egreso.value == "fallecido" %}selected{% endif %}>Fallecido</option>
                        </select>
                        {% if form.condicion_egreso.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.condicion_egreso.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.control_posterior.id_for_label }}" class="form-label">
                            {{ form.control_posterior.label }}
                        </label>
                        <input type="text" 
                               id="{{ form.control_posterior.id_for_label }}" 
                               name="{{ form.control_posterior.name }}"
                               class="form-input" 
                               placeholder="Ej: Control en 7 días en policlínico"
                               value="{{ form.control_posterior.value|default:'' }}">
                        <p class="form-hint">Indicaciones para control posterior al alta</p>
                        {% if form.control_posterior.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.control_posterior.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.indicaciones_alta.id_for_label }}" class="form-label">
                        {{ form.indicaciones_alta.label }}
                    </label>
                    <textarea id="{{ form.indicaciones_alta.id_for_label }}" 
                              name="{{ form.indicaciones_alta.name }}"
                              class="form-textarea" 
                              rows="3"
                              placeholder="Recomendaciones generales al alta">{{ form.indicaciones_alta.value|default:'' }}</textarea>
                    <p class="form-hint">Recomendaciones generales al alta</p>
                    {% if form.indicaciones_alta.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.indicaciones_alta.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                        {{ form.observaciones.label }}
                    </label>
                    <textarea id="{{ form.observaciones.id_for_label }}" 
                              name="{{ form.observaciones.name }}"
                              class="form-textarea" 
                              rows="2"
                              placeholder="Observaciones adicionales">{{ form.observaciones.value|default:'' }}</textarea>
                    {% if form.observaciones.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.observaciones.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- SECCIÓN 2: INDICACIONES MÉDICAS -->
            <div style="background: #d1fae5; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #10b981;">
                <h3 style="font-size: 18px; font-weight: 600; color: #065f46; margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: #10b981;">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Indicaciones Médicas
                </h3>

                <!-- Formulario de nueva indicación -->
                <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #10b981;">
                    <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Tipo</label>
                            <select id="new-tipo" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="medicamento">Medicamento</option>
                                <option value="procedimiento">Procedimiento</option>
                                <option value="cuidado">Cuidado de Enfermería</option>
                                <option value="dieta">Dieta</option>
                                <option value="reposo">Reposo</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Descripción *</label>
                            <input type="text" id="new-descripcion" class="form-input" placeholder="Ej: Paracetamol">
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Dosis</label>
                            <input type="text" id="new-dosis" class="form-input" placeholder="Ej: 500mg">
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Vía</label>
                            <input type="text" id="new-via" class="form-input" placeholder="Ej: Oral">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Frecuencia</label>
                        <input type="text" id="new-frecuencia" class="form-input" placeholder="Ej: Cada 8 horas">
                    </div>

                    <button type="button" id="btn-agregar-indicacion" class="btn btn-success" style="width: 100%; margin-top: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Agregar Indicación
                    </button>
                </div>

                <!-- Lista de indicaciones agregadas -->
                <div id="indicaciones-lista" style="background: white; border-radius: 8px; padding: 16px; border: 1px solid #d1d5db;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #065f46; margin-bottom: 12px;">Indicaciones Agregadas:</h4>
                    <div id="indicaciones-container" style="display: none;">
                        <!-- Las indicaciones se agregarán aquí dinámicamente -->
                    </div>
                    <p id="no-indicaciones" style="font-size: 14px; color: #6b7280; text-align: center;">
                        No hay indicaciones agregadas aún
                    </p>
                </div>

                <!-- Formset oculto para Django -->
                {{ formset.management_form }}
                <div id="formset-container" style="display: none;">
                    {% for form in formset %}
                        <div class="formset-form" data-form-index="{{ forloop.counter0 }}">
                            {{ form.id }}
                            {{ form.tipo }}
                            {{ form.descripcion }}
                            {{ form.dosis }}
                            {{ form.via }}
                            {{ form.frecuencia }}
                            {{ form.DELETE }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Información importante -->
            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #f59e0b; flex-shrink: 0;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div>
                        <p style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                            Importante - Epicrisis Médica
                        </p>
                        <ul style="font-size: 14px; color: #92400e; list-style: disc; margin-left: 20px; line-height: 1.8;">
                            <li>Esta epicrisis quedará registrada permanentemente en el sistema</li>
                            <li>Los campos marcados con <strong>*</strong> son obligatorios</li>
                            <li>Las indicaciones médicas deben ser claras y específicas</li>
                            <li>La información será visible para el personal médico autorizado</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="btn-group">
                <a href="{% url 'core:epicrisis_list' %}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Guardar Epicrisis e Indicaciones
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    let indicacionesCount = 0;
    const btnAgregar = document.getElementById('btn-agregar-indicacion');
    const indicacionesContainer = document.getElementById('indicaciones-container');
    const noIndicaciones = document.getElementById('no-indicaciones');
    const totalForms = document.getElementById('id_indicaciones-TOTAL_FORMS');
    
    // Cargar indicaciones existentes si estamos editando
    const formsetForms = document.querySelectorAll('.formset-form');
    formsetForms.forEach((formDiv) => {
        const tipoSelect = formDiv.querySelector('[name$="-tipo"]');
        const descripcionInput = formDiv.querySelector('[name$="-descripcion"]');
        const dosisInput = formDiv.querySelector('[name$="-dosis"]');
        const viaInput = formDiv.querySelector('[name$="-via"]');
        const frecuenciaInput = formDiv.querySelector('[name$="-frecuencia"]');
        const deleteCheckbox = formDiv.querySelector('[name$="-DELETE"]');
        const formIndex = formDiv.dataset.formIndex;
        
        if (descripcionInput && descripcionInput.value && !deleteCheckbox.checked) {
            const tipoText = tipoSelect.options[tipoSelect.selectedIndex].text;
            agregarIndicacionALista(
                tipoText,
                tipoSelect.value,
                descripcionInput.value,
                dosisInput.value,
                viaInput.value,
                frecuenciaInput.value,
                formIndex
            );
            indicacionesCount++;
        }
    });
    
    // Actualizar visibilidad
    if (indicacionesCount > 0) {
        indicacionesContainer.style.display = 'block';
        noIndicaciones.style.display = 'none';
    }
    
    btnAgregar.addEventListener('click', () => {
        const tipo = document.getElementById('new-tipo').value;
        const descripcion = document.getElementById('new-descripcion').value.trim();
        const dosis = document.getElementById('new-dosis').value.trim();
        const via = document.getElementById('new-via').value.trim();
        const frecuencia = document.getElementById('new-frecuencia').value.trim();
        
        if (!tipo) {
            alert('Debe seleccionar un tipo de indicación');
            document.getElementById('new-tipo').focus();
            return;
        }
        
        if (!descripcion) {
            alert('La descripción es obligatoria');
            document.getElementById('new-descripcion').focus();
            return;
        }
        
        // Agregar al formset oculto
        const newFormIdx = parseInt(totalForms.value);
        const tipoText = document.getElementById('new-tipo').options[document.getElementById('new-tipo').selectedIndex].text;
        
        // Crear campos ocultos para el formset
        const formsetContainer = document.getElementById('formset-container');
        const newFormDiv = document.createElement('div');
        newFormDiv.className = 'formset-form';
        newFormDiv.dataset.formIndex = newFormIdx;
        newFormDiv.innerHTML = `
            <input type="hidden" name="indicaciones-${newFormIdx}-id" value="">
            <input type="hidden" name="indicaciones-${newFormIdx}-tipo" value="${tipo}">
            <input type="hidden" name="indicaciones-${newFormIdx}-descripcion" value="${descripcion}">
            <input type="hidden" name="indicaciones-${newFormIdx}-dosis" value="${dosis}">
            <input type="hidden" name="indicaciones-${newFormIdx}-via" value="${via}">
            <input type="hidden" name="indicaciones-${newFormIdx}-frecuencia" value="${frecuencia}">
            <input type="hidden" name="indicaciones-${newFormIdx}-DELETE" value="">
        `;
        formsetContainer.appendChild(newFormDiv);
        
        // Agregar a la lista visual
        agregarIndicacionALista(tipoText, tipo, descripcion, dosis, via, frecuencia, newFormIdx);
        
        // Incrementar contador
        totalForms.value = newFormIdx + 1;
        indicacionesCount++;
        
        // Limpiar campos
        document.getElementById('new-tipo').value = '';
        document.getElementById('new-descripcion').value = '';
        document.getElementById('new-dosis').value = '';
        document.getElementById('new-via').value = '';
        document.getElementById('new-frecuencia').value = '';
        
        // Enfocar el primer campo
        document.getElementById('new-tipo').focus();
        
        // Mostrar lista
        indicacionesContainer.style.display = 'block';
        noIndicaciones.style.display = 'none';
    });
    
    function agregarIndicacionALista(tipoText, tipoValue, descripcion, dosis, via, frecuencia, index) {
        const indicacionDiv = document.createElement('div');
        indicacionDiv.style.cssText = 'background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #10b981;';
        indicacionDiv.dataset.index = index;
        
        let detalles = '';
        if (dosis) detalles += `<strong>Dosis:</strong> ${dosis} | `;
        if (via) detalles += `<strong>Vía:</strong> ${via} | `;
        if (frecuencia) detalles += `<strong>Frecuencia:</strong> ${frecuencia}`;
        
        // Limpiar el último " | " si existe
        if (detalles.endsWith(' | ')) {
            detalles = detalles.slice(0, -3);
        }
        
        indicacionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                            ${tipoText.toUpperCase()}
                        </span>
                        <span style="font-weight: 600; color: #1f2937;">${descripcion}</span>
                    </div>
                    ${detalles ? `<div style="font-size: 13px; color: #6b7280; margin-top: 4px;">${detalles}</div>` : ''}
                </div>
                <button type="button" class="btn-eliminar-indicacion" data-index="${index}" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px; flex-shrink: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
        `;
        
        indicacionesContainer.appendChild(indicacionDiv);
        
        // Agregar evento de eliminar
        indicacionDiv.querySelector('.btn-eliminar-indicacion').addEventListener('click', function() {
            const idx = this.dataset.index;
            
            // Marcar como eliminado en el formset
            const deleteInput = document.querySelector(`[name="indicaciones-${idx}-DELETE"]`);
            if (deleteInput) {
                deleteInput.value = 'on';
            }
            
            // Eliminar visualmente
            indicacionDiv.remove();
            indicacionesCount--;
            
            if (indicacionesCount === 0) {
                indicacionesContainer.style.display = 'none';
                noIndicaciones.style.display = 'block';
            }
        });
    }
});

// Validación antes de enviar
document.querySelector('form').addEventListener('submit', function(e) {
    const resumenEvolucion = document.getElementById('{{ form.resumen_evolucion.id_for_label }}');
    const diagnosticoEgreso = document.getElementById('{{ form.diagnostico_egreso.id_for_label }}');
    const condicionEgreso = document.getElementById('{{ form.condicion_egreso.id_for_label }}');

    let errores = [];

    if (!resumenEvolucion.value.trim()) {
        errores.push('Resumen de Evolución es obligatorio');
        resumenEvolucion.style.borderColor = 'var(--primary-red)';
    } else {
        resumenEvolucion.style.borderColor = '';
    }

    if (!diagnosticoEgreso.value.trim()) {
        errores.push('Diagnóstico de Egreso es obligatorio');
        diagnosticoEgreso.style.borderColor = 'var(--primary-red)';
    } else {
        diagnosticoEgreso.style.borderColor = '';
    }

    if (!condicionEgreso.value) {
        errores.push('Condición al Egreso es obligatoria');
        condicionEgreso.style.borderColor = 'var(--primary-red)';
    } else {
        condicionEgreso.style.borderColor = '';
    }

    if (errores.length > 0) {
        e.preventDefault();
        alert('Por favor complete los campos obligatorios:\n\n' + errores.join('\n'));
        // Hacer scroll al primer campo con error
        if (!resumenEvolucion.value.trim()) {
            resumenEvolucion.focus();
        } else if (!diagnosticoEgreso.value.trim()) {
            diagnosticoEgreso.focus();
        } else if (!condicionEgreso.value) {
            condicionEgreso.focus();
        }
        return false;
    }
});
</script>
{% endblock %}

<style>
/* Estilos consistentes con los demás formularios del proyecto */
.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 15px;
    transition: all 0.2s;
    background: white;
    font-family: inherit;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
}

/* Botón de eliminar indicación */
.btn-eliminar-indicacion:hover {
    background: #dc2626 !important;
    transform: scale(1.05);
    transition: all 0.2s;
}

/* Responsive */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}