{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 1000px; margin: 0 auto;">
    <div class="card">
        <h2 class="card-header">{{ title }}</h2>

        <!-- Información de la madre -->
        <div style="background: #e0f2fe; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-900); margin: 0;">
                    Madre: {{ madre.nombre_descifrado }}
                </h3>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 14px; color: var(--gray-700); margin-top: 12px;">
                <div>
                    <strong>RUT:</strong> {{ madre.rut_descifrado }}
                </div>
                <div>
                    <strong>Tipo Parto:</strong> 
                    <span class="badge {% if 'Cesárea' in parto.tipo_parto %}badge-yellow{% else %}badge-green{% endif %}">
                        {{ parto.tipo_parto }}
                    </span>
                </div>
                <div>
                    <strong>Fecha:</strong> {{ parto.fecha_parto|date:"d/m/Y H:i" }}
                </div>
            </div>
        </div>

        <form method="post">
            {% csrf_token %}

            <!-- SECCIÓN 1: EPICRISIS -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--gray-200);">
                <h3 style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: var(--primary-blue);">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Datos de Epicrisis
                </h3>

                <div class="form-group">
                    <label for="{{ form.motivo_ingreso.id_for_label }}" class="form-label">
                        {{ form.motivo_ingreso.label }}
                    </label>
                    {{ form.motivo_ingreso }}
                    <p class="form-hint">Razón principal del ingreso hospitalario</p>
                    {% if form.motivo_ingreso.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.motivo_ingreso.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.resumen_evolucion.id_for_label }}" class="form-label required">
                        {{ form.resumen_evolucion.label }}
                    </label>
                    {{ form.resumen_evolucion }}
                    <p class="form-hint">Descripción de la evolución del paciente durante la hospitalización</p>
                    {% if form.resumen_evolucion.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.resumen_evolucion.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.diagnostico_egreso.id_for_label }}" class="form-label required">
                        {{ form.diagnostico_egreso.label }}
                    </label>
                    {{ form.diagnostico_egreso }}
                    <p class="form-hint">Diagnóstico principal y secundarios al momento del egreso</p>
                    {% if form.diagnostico_egreso.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.diagnostico_egreso.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.condicion_egreso.id_for_label }}" class="form-label required">
                            {{ form.condicion_egreso.label }}
                        </label>
                        {{ form.condicion_egreso }}
                        {% if form.condicion_egreso.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.condicion_egreso.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.control_posterior.id_for_label }}" class="form-label">
                            {{ form.control_posterior.label }}
                        </label>
                        {{ form.control_posterior }}
                        <p class="form-hint">Ejemplo: Control en 7 días en policlínico</p>
                        {% if form.control_posterior.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.control_posterior.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.indicaciones_alta.id_for_label }}" class="form-label">
                        {{ form.indicaciones_alta.label }}
                    </label>
                    {{ form.indicaciones_alta }}
                    <p class="form-hint">Recomendaciones generales al alta</p>
                    {% if form.indicaciones_alta.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.indicaciones_alta.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                        {{ form.observaciones.label }}
                    </label>
                    {{ form.observaciones }}
                    {% if form.observaciones.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.observaciones.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- SECCIÓN 2: INDICACIONES MÉDICAS -->
            <div style="background: #d1fae5; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #10b981;">
                <h3 style="font-size: 18px; font-weight: 600; color: #065f46; margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: #10b981;">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Indicaciones Médicas
                </h3>

                {{ formset.management_form }}
                
                <!-- Tabla de indicaciones existentes -->
                <div id="indicaciones-table" style="background: white; border-radius: 8px; overflow: hidden; margin-bottom: 16px;">
                    {% if formset.forms %}
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #10b981; color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Tipo</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Descripción</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Dosis</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Vía</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Frecuencia</th>
                                <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; text-transform: uppercase; width: 80px;">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="indicaciones-tbody">
                            {% for form in formset %}
                            <tr class="indicacion-row" style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px;">
                                    {{ form.id }}
                                    <select name="{{ form.tipo.html_name }}" id="{{ form.tipo.id_for_label }}" class="form-select" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        {% for value, label in form.tipo.field.choices %}
                                        <option value="{{ value }}" {% if form.tipo.value == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td style="padding: 12px;">
                                    <input type="text" name="{{ form.descripcion.html_name }}" id="{{ form.descripcion.id_for_label }}" class="form-input" placeholder="Ej: Paracetamol" value="{{ form.descripcion.value|default:'' }}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </td>
                                <td style="padding: 12px;">
                                    <input type="text" name="{{ form.dosis.html_name }}" id="{{ form.dosis.id_for_label }}" class="form-input" placeholder="Ej: 500mg" value="{{ form.dosis.value|default:'' }}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </td>
                                <td style="padding: 12px;">
                                    <input type="text" name="{{ form.via.html_name }}" id="{{ form.via.id_for_label }}" class="form-input" placeholder="Ej: Oral" value="{{ form.via.value|default:'' }}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </td>
                                <td style="padding: 12px;">
                                    <input type="text" name="{{ form.frecuencia.html_name }}" id="{{ form.frecuencia.id_for_label }}" class="form-input" placeholder="Ej: Cada 8 horas" value="{{ form.frecuencia.value|default:'' }}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if form.instance.pk %}
                                    <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                        {{ form.DELETE }}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            <line x1="10" y1="11" x2="10" y2="17"/>
                                            <line x1="14" y1="11" x2="14" y2="17"/>
                                        </svg>
                                    </label>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div style="padding: 40px; text-align: center; color: #6b7280;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px; opacity: 0.3;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        <p style="font-size: 14px;">No hay indicaciones médicas registradas</p>
                        <p style="font-size: 12px; margin-top: 8px;">Presione el botón de abajo para agregar una</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Template para nuevas indicaciones (oculto) -->
                <table style="display: none;">
                    <tbody id="empty-form-template">
                        <tr class="indicacion-row" style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px;">
                                {{ formset.empty_form.id }}
                                <select name="{{ formset.empty_form.tipo.html_name }}" id="{{ formset.empty_form.tipo.id_for_label }}" class="form-select" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    {% for value, label in formset.empty_form.tipo.field.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td style="padding: 12px;">
                                <input type="text" name="{{ formset.empty_form.descripcion.html_name }}" id="{{ formset.empty_form.descripcion.id_for_label }}" class="form-input" placeholder="Ej: Paracetamol" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </td>
                            <td style="padding: 12px;">
                                <input type="text" name="{{ formset.empty_form.dosis.html_name }}" id="{{ formset.empty_form.dosis.id_for_label }}" class="form-input" placeholder="Ej: 500mg" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </td>
                            <td style="padding: 12px;">
                                <input type="text" name="{{ formset.empty_form.via.html_name }}" id="{{ formset.empty_form.via.id_for_label }}" class="form-input" placeholder="Ej: Oral" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </td>
                            <td style="padding: 12px;">
                                <input type="text" name="{{ formset.empty_form.frecuencia.html_name }}" id="{{ formset.empty_form.frecuencia.id_for_label }}" class="form-input" placeholder="Ej: Cada 8 horas" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button type="button" class="btn-delete-new" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button type="button" id="add-form" class="btn btn-success" style="margin-top: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                    Agregar Indicación
                </button>
            </div>

            <!-- Información importante -->
            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #f59e0b; flex-shrink: 0;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div>
                        <p style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                            Importante - Epicrisis Médica
                        </p>
                        <ul style="font-size: 14px; color: #92400e; list-style: disc; margin-left: 20px; line-height: 1.8;">
                            <li>Esta epicrisis quedará registrada permanentemente en el sistema</li>
                            <li>Los campos marcados con <strong>*</strong> son obligatorios</li>
                            <li>Las indicaciones médicas deben ser claras y específicas</li>
                            <li>La información será visible para el personal médico autorizado</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="btn-group">
                <a href="{% url 'core:epicrisis_list' %}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Guardar Epicrisis e Indicaciones
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    // Script para manejar el Formset dinámico
    document.addEventListener('DOMContentLoaded', () => {
        const addButton = document.getElementById('add-form');
        const totalForms = document.getElementById('id_indicaciones-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form-template');
        const indicacionesTable = document.getElementById('indicaciones-table');

        // Función para agregar nueva fila
        addButton.addEventListener('click', () => {
            // Si no existe la tabla, crearla
            let tbody = document.getElementById('indicaciones-tbody');
            if (!tbody) {
                indicacionesTable.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #10b981; color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Tipo</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Descripción</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Dosis</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Vía</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase;">Frecuencia</th>
                                <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; text-transform: uppercase; width: 80px;">Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="indicaciones-tbody"></tbody>
                    </table>
                `;
                tbody = document.getElementById('indicaciones-tbody');
            }

            const newFormIdx = parseInt(totalForms.value);
            const newRow = emptyFormTemplate.querySelector('tr').cloneNode(true);
            
            // Reemplazar __prefix__ con el índice real
            newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, newFormIdx);
            
            // Agregar evento de eliminar para la nueva fila
            const deleteBtn = newRow.querySelector('.btn-delete-new');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    newRow.remove();
                    // Si no quedan filas, mostrar mensaje de vacío
                    if (tbody.children.length === 0) {
                        indicacionesTable.innerHTML = `
                            <div style="padding: 40px; text-align: center; color: #6b7280;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px; opacity: 0.3;">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                                <p style="font-size: 14px;">No hay indicaciones médicas registradas</p>
                                <p style="font-size: 12px; margin-top: 8px;">Presione el botón de abajo para agregar una</p>
                            </div>
                        `;
                    }
                });
            }
            
            tbody.appendChild(newRow);
            totalForms.value = newFormIdx + 1;
        });
    });

    // Validación antes de enviar
    document.querySelector('form').addEventListener('submit', function(e) {
        const resumenEvolucion = document.getElementById('{{ form.resumen_evolucion.id_for_label }}');
        const diagnosticoEgreso = document.getElementById('{{ form.diagnostico_egreso.id_for_label }}');
        const condicionEgreso = document.getElementById('{{ form.condicion_egreso.id_for_label }}');

        let errores = [];

        if (!resumenEvolucion.value.trim()) {
            errores.push('Resumen de Evolución es obligatorio');
            resumenEvolucion.style.borderColor = 'var(--primary-red)';
        }

        if (!diagnosticoEgreso.value.trim()) {
            errores.push('Diagnóstico de Egreso es obligatorio');
            diagnosticoEgreso.style.borderColor = 'var(--primary-red)';
        }

        if (!condicionEgreso.value) {
            errores.push('Condición al Egreso es obligatoria');
            condicionEgreso.style.borderColor = 'var(--primary-red)';
        }

        if (errores.length > 0) {
            e.preventDefault();
            alert('Por favor complete los campos obligatorios:\n\n' + errores.join('\n'));
            return false;
        }
    });
</script>
{% endblock %}

<style>
/* Estilos mejorados para los inputs del formulario */
.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 15px;
    transition: all 0.2s;
    background: white;
    font-family: inherit;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
}

/* Hover effect para las filas de la tabla */
.indicacion-row:hover {
    background: #f9fafb;
}

/* Estilo para checkboxes de eliminar */
input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
    #indicaciones-table table {
        font-size: 12px;
    }
    
    #indicaciones-table th,
    #indicaciones-table td {
        padding: 8px !important;
    }
}
</style>
{% endblock %}