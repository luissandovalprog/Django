{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 900px; margin: 0 auto;">
    
    <!-- Alerta de Trazabilidad -->
    <div class="alert alert-warning" style="margin-bottom: 24px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <div>
            <strong>Anexar Corrección - Trazabilidad Completa</strong>
            <p>Esta acción NO sobrescribe el dato original. Se anexa una corrección que queda registrada en auditoría según Ley 20.584.</p>
        </div>
    </div>

    <div class="card">
        <h2 class="card-header">{{ title }}</h2>

        <!-- Información del Registro -->
        <div style="background: #e0f2fe; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
            <h3 style="font-size: 16px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">
                Información del Registro
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 14px;">
                <div>
                    <strong>Madre:</strong> {{ madre.nombre_descifrado }}
                </div>
                <div>
                    <strong>RUT:</strong> {{ madre.rut_descifrado }}
                </div>
                <div>
                    <strong>Tipo Parto:</strong> 
                    <span class="badge {% if 'Cesárea' in parto.tipo_parto %}badge-yellow{% else %}badge-green{% endif %}">
                        {{ parto.tipo_parto }}
                    </span>
                </div>
                <div>
                    <strong>Registrado por:</strong> {{ parto.usuario_registro.nombre_completo }}
                </div>
            </div>
        </div>

        <form method="post" id="correccionForm">
            {% csrf_token %}

            <!-- Campo Dropdown (Ahora se renderiza correctamente) -->
            <div class="form-group">
                <label for="{{ form.campo_corregido.id_for_label }}" class="form-label required">
                    {{ form.campo_corregido.label }}
                </label>
                {{ form.campo_corregido }}
                <p class="form-hint">Seleccione el campo que desea corregir</p>
                {% if form.campo_corregido.errors %}
                    <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                        {{ form.campo_corregido.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.valor_original.id_for_label }}" class="form-label">
                        {{ form.valor_original.label }}
                        <span style="font-size: 12px; color: var(--primary-blue); font-weight: normal;">
                            (Se carga automáticamente)
                        </span>
                    </label>
                    {{ form.valor_original }}
                    {% if form.valor_original.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.valor_original.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.valor_nuevo.id_for_label }}" class="form-label required">
                        {{ form.valor_nuevo.label }}
                    </label>
                    {{ form.valor_nuevo }}
                    <p class="form-hint">Valor corregido</p>
                    {% if form.valor_nuevo.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.valor_nuevo.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.justificacion.id_for_label }}" class="form-label required">
                    {{ form.justificacion.label }}
                </label>
                {{ form.justificacion }}
                <p class="form-hint">Justificación médica detallada (mínimo 20 caracteres)</p>
                <p id="charCounter" style="font-size: 13px; color: var(--gray-500); margin-top: 4px; text-align: right;">
                    0 / 20 caracteres mínimos
                </p>
                {% if form.justificacion.errors %}
                    <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                        {{ form.justificacion.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Información Legal -->
            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #f59e0b; flex-shrink: 0;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <div>
                        <p style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                            Marco Legal - Ley 20.584
                        </p>
                        <ul style="font-size: 14px; color: #92400e; list-style: disc; margin-left: 20px; line-height: 1.8;">
                            <li>El registro original permanece intacto en la base de datos</li>
                            <li>Esta corrección se anexa como registro adicional</li>
                            <li>Queda registrado quién, cuándo y por qué se realizó la corrección</li>
                            <li>Solo usuarios con rol de Médico pueden anexar correcciones</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" style="display: none; background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                <svg style="display: inline-block; width: 20px; height: 20px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span style="margin-left: 8px; color: var(--primary-blue); font-weight: 600;">
                    Cargando valor original...
                </span>
            </div>

            <div class="btn-group">
                <a href="{% url 'core:parto_detail' parto.pk %}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                    Anexar Corrección
                </button>
            </div>
        </form>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

#id_valor_original.loading {
    background: #f3f4f6;
    border-color: var(--primary-blue);
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const campoSelect = document.getElementById('id_campo_corregido');
    const valorOriginalInput = document.getElementById('id_valor_original');
    const justificacionTextarea = document.getElementById('id_justificacion');
    const charCounter = document.getElementById('charCounter');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Datos del objeto actual
    const tipoModelo = 'parto';
    const objetoId = '{{ parto.pk }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // ========== AJAX: Cargar Valor Original ==========
    campoSelect.addEventListener('change', async function() {
        const campo = this.value;
        
        if (!campo) {
            valorOriginalInput.value = '';
            return;
        }
        
        // Mostrar loading
        loadingIndicator.style.display = 'block';
        valorOriginalInput.classList.add('loading');
        valorOriginalInput.value = 'Cargando...';
        
        try {
            const response = await fetch('{% url "core:obtener_valor_campo" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    tipo_modelo: tipoModelo,
                    objeto_id: objetoId,
                    campo: campo
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                valorOriginalInput.value = data.valor || '(Sin valor)';
            } else {
                valorOriginalInput.value = 'Error: ' + data.error;
                alert('Error al cargar el valor: ' + data.error);
            }
        } catch (error) {
            console.error('Error en AJAX:', error);
            valorOriginalInput.value = 'Error de conexión';
            alert('Error al conectar con el servidor. Intente nuevamente.');
        } finally {
            loadingIndicator.style.display = 'none';
            valorOriginalInput.classList.remove('loading');
        }
    });
    
    // ========== Contador de Caracteres ==========
    justificacionTextarea.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = `${length} / 20 caracteres mínimos`;
        
        if (length < 20) {
            charCounter.style.color = 'var(--primary-red)';
        } else {
            charCounter.style.color = 'var(--primary-green)';
        }
    });
    
    // Inicializar contador
    if (justificacionTextarea.value) {
        justificacionTextarea.dispatchEvent(new Event('input'));
    }
    
    // ========== Validación de Formulario ==========
    document.getElementById('correccionForm').addEventListener('submit', function(e) {
        const campo = campoSelect.value;
        const valorNuevo = document.getElementById('id_valor_nuevo').value.trim();
        const justificacion = justificacionTextarea.value.trim();
        
        if (!campo) {
            e.preventDefault();
            alert('Por favor, seleccione un campo a corregir.');
            campoSelect.focus();
            return false;
        }
        
        if (!valorNuevo) {
            e.preventDefault();
            alert('Por favor, ingrese el valor corregido.');
            document.getElementById('id_valor_nuevo').focus();
            return false;
        }
        
        if (justificacion.length < 20) {
            e.preventDefault();
            alert('La justificación debe tener al menos 20 caracteres.');
            justificacionTextarea.focus();
            return false;
        }
        
        // Confirmación final
        if (!confirm('¿Está seguro de anexar esta corrección? Esta acción quedará registrada en auditoría.')) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}