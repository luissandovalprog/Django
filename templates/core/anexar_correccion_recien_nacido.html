{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 900px; margin: 0 auto;">
    
    <!-- Alerta de Trazabilidad -->
    <div class="alert alert-warning" style="margin-bottom: 24px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <div>
            <strong>Anexar Corrección - Trazabilidad Completa</strong>
            <p>Esta acción NO sobrescribe el dato original. Se anexa una corrección que queda registrada en auditoría según Ley 20.584.</p>
        </div>
    </div>

    <div class="card">
        <h2 class="card-header">{{ title }}</h2>

        <!-- Información del Recién Nacido -->
        <div style="background: #d1fae5; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #10b981;">
            <h3 style="font-size: 16px; font-weight: 600; color: #065f46; margin-bottom: 8px;">
                Información del Recién Nacido
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 14px; color: #065f46;">
                <div>
                    <strong>RUT Provisorio:</strong> {{ recien_nacido.rut_provisorio|default:"Sin RUT" }}
                </div>
                <div>
                    <strong>Estado:</strong> {{ recien_nacido.estado_al_nacer }}
                </div>
                <div>
                    <strong>Peso:</strong> {{ recien_nacido.peso_gramos|default:"N/A" }}g
                </div>
                <div>
                    <strong>Talla:</strong> {{ recien_nacido.talla_cm|default:"N/A" }} cm
                </div>
                <div>
                    <strong>APGAR:</strong> {{ recien_nacido.apgar_1_min|default:"-" }}/{{ recien_nacido.apgar_5_min|default:"-" }}
                </div>
                <div>
                    <strong>Madre:</strong> {{ parto.madre.get_nombre }}
                </div>
            </div>
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="{{ form.campo_corregido.id_for_label }}" class="form-label required">
                    {{ form.campo_corregido.label }}
                </label>
                {{ form.campo_corregido }}
                <p class="form-hint">Ej: peso_gramos, talla_cm, apgar_1_min, apgar_5_min, rut_provisorio</p>
                {% if form.campo_corregido.errors %}
                    <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                        {{ form.campo_corregido.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.valor_original.id_for_label }}" class="form-label">
                        {{ form.valor_original.label }}
                    </label>
                    {{ form.valor_original }}
                    <p class="form-hint">Valor actual en el sistema</p>
                    {% if form.valor_original.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.valor_original.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.valor_nuevo.id_for_label }}" class="form-label required">
                        {{ form.valor_nuevo.label }}
                    </label>
                    {{ form.valor_nuevo }}
                    <p class="form-hint">Valor corregido</p>
                    {% if form.valor_nuevo.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.valor_nuevo.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.justificacion.id_for_label }}" class="form-label required">
                    {{ form.justificacion.label }}
                </label>
                {{ form.justificacion }}
                <p class="form-hint">Justificación médica detallada (mínimo 20 caracteres)</p>
                {% if form.justificacion.errors %}
                    <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                        {{ form.justificacion.errors|join:", " }}
                    </p>
                {% endif %}
            </div>

            <!-- Información Legal -->
            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #f59e0b; flex-shrink: 0;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <div>
                        <p style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                            Marco Legal - Ley 20.584
                        </p>
                        <ul style="font-size: 14px; color: #92400e; list-style: disc; margin-left: 20px; line-height: 1.8;">
                            <li>El registro original permanece intacto en la base de datos</li>
                            <li>Esta corrección se anexa como registro adicional</li>
                            <li>Queda registrado quién, cuándo y por qué se realizó la corrección</li>
                            <li>Solo usuarios con rol de Médico pueden anexar correcciones</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <a href="{% url 'core:parto_detail' parto.pk %}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                    Anexar Corrección
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}