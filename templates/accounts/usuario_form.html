{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 900px; margin: 0 auto;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 24px; font-weight: 700; color: var(--gray-900); margin: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: var(--primary-blue);">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    {% if is_new %}
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                    {% else %}
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                    {% endif %}
                </svg>
                {{ title }}
            </h2>
        </div>

        {% if not is_new %}
        <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
            <p style="font-size: 14px; color: #1e40af; margin: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Editando usuario <strong>{{ usuario.username }}</strong> - Creado el {{ usuario.fecha_creacion|date:"d/m/Y" }}
            </p>
        </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}

            <!-- Información Básica -->
            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--gray-200);">
                <h3 style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px;">
                    Información Básica
                </h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.nombre_completo.id_for_label }}" class="form-label required">
                            {{ form.nombre_completo.label }}
                        </label>
                        {{ form.nombre_completo }}
                        <p class="form-hint">Nombre completo del usuario</p>
                        {% if form.nombre_completo.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.nombre_completo.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.rut.id_for_label }}" class="form-label required">
                            {{ form.rut.label }}
                        </label>
                        {{ form.rut }}
                        <p class="form-hint">Formato: 12.345.678-9</p>
                        {% if form.rut.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.rut.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}" class="form-label required">
                        {{ form.email.label }}
                    </label>
                    {{ form.email }}
                    <p class="form-hint">Correo electrónico institucional</p>
                    {% if form.email.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.email.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Credenciales de Acceso -->
            <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #f59e0b;">
                <h3 style="font-size: 18px; font-weight: 600; color: #92400e; margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: #f59e0b;">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Credenciales de Acceso
                </h3>

                <div class="form-group">
                    <label for="{{ form.username.id_for_label }}" class="form-label required">
                        {{ form.username.label }}
                    </label>
                    {{ form.username }}
                    {% if not is_new %}
                        <p class="form-hint">El nombre de usuario no puede ser modificado</p>
                    {% else %}
                        <p class="form-hint">Será usado para iniciar sesión</p>
                    {% endif %}
                    {% if form.username.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.username.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                {% if is_new %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.password1.id_for_label }}" class="form-label required">
                            {{ form.password1.label }}
                        </label>
                        {{ form.password1 }}
                        <p class="form-hint">{{ form.password1.help_text }}</p>
                        {% if form.password1.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.password1.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.password2.id_for_label }}" class="form-label required">
                            {{ form.password2.label }}
                        </label>
                        {{ form.password2 }}
                        <p class="form-hint">Repita la contraseña</p>
                        {% if form.password2.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.password2.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.nueva_password.id_for_label }}" class="form-label">
                            {{ form.nueva_password.label }}
                        </label>
                        {{ form.nueva_password }}
                        <p class="form-hint">{{ form.nueva_password.help_text }}</p>
                        {% if form.nueva_password.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.nueva_password.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.confirmar_password.id_for_label }}" class="form-label">
                            {{ form.confirmar_password.label }}
                        </label>
                        {{ form.confirmar_password }}
                        <p class="form-hint">Confirme la nueva contraseña</p>
                        {% if form.confirmar_password.errors %}
                            <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                                {{ form.confirmar_password.errors|join:", " }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Rol y Permisos -->
            <div style="background: #e0e7ff; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #6366f1;">
                <h3 style="font-size: 18px; font-weight: 600; color: #4338ca; margin-bottom: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; color: #6366f1;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Rol y Permisos
                </h3>

                <div class="form-group">
                    <label for="{{ form.rol.id_for_label }}" class="form-label required">
                        {{ form.rol.label }}
                    </label>
                    {{ form.rol }}
                    <p class="form-hint">Define los permisos del usuario según RBAC</p>
                    {% if form.rol.errors %}
                        <p style="color: var(--primary-red); font-size: 13px; margin-top: 4px;">
                            {{ form.rol.errors|join:", " }}
                        </p>
                    {% endif %}
                </div>

                <div style="display: flex; gap: 32px; margin-top: 16px;">
                    <div class="form-checkbox">
                        {{ form.activo }}
                        <label for="{{ form.activo.id_for_label }}" style="font-weight: normal; cursor: pointer; margin-left: 8px;">
                            {{ form.activo.label }}
                        </label>
                        <p class="form-hint" style="margin-left: 26px;">El usuario podrá iniciar sesión</p>
                    </div>

                    {% if not is_new %}
                    <div class="form-checkbox">
                        {{ form.is_staff }}
                        <label for="{{ form.is_staff.id_for_label }}" style="font-weight: normal; cursor: pointer; margin-left: 8px;">
                            {{ form.is_staff.label }}
                        </label>
                        <p class="form-hint" style="margin-left: 26px;">Acceso al panel de administración de Django</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Información sobre RBAC -->
            <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #2563eb; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div>
                        <p style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">
                            Principio de Segmentación RBAC
                        </p>
                        <ul style="font-size: 14px; color: #1e40af; list-style: disc; margin-left: 20px; line-height: 1.6;">
                            <li><strong>Matronas y Enfermeras:</strong> Solo acceden a pacientes de su turno asignado</li>
                            <li><strong>Administrativos:</strong> NO ven datos clínicos, solo información demográfica</li>
                            <li><strong>Admin Sistema:</strong> NO accede a datos de pacientes, solo gestiona usuarios y auditoría</li>
                            <li><strong>Médicos:</strong> Pueden anexar correcciones sin modificar registros originales</li>
                            <li><strong>Supervisores:</strong> Acceso completo a todos los registros y reportes</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="btn-group">
                <a href="{% url 'accounts:gestion_usuarios' %}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        {% if is_new %}
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                        {% else %}
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                        {% endif %}
                    </svg>
                    {% if is_new %}Guardar Usuario{% else %}Actualizar Usuario{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
// Validación de RUT chileno en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const rutInput = document.getElementById('{{ form.rut.id_for_label }}');
    
    if (rutInput) {
        rutInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9kK]/g, '');
            
            if (value.length > 1) {
                const dv = value.slice(-1);
                const number = value.slice(0, -1);
                
                // Formatear con puntos
                const formattedNumber = number.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                e.target.value = `${formattedNumber}-${dv}`;
            }
        });

        // Validación al perder el foco
        rutInput.addEventListener('blur', function(e) {
            const rut = e.target.value;
            if (rut && !validarRUT(rut)) {
                e.target.style.borderColor = 'var(--primary-red)';
                
                // Mostrar mensaje de error
                const errorMsg = e.target.parentElement.querySelector('.rut-error');
                if (!errorMsg) {
                    const error = document.createElement('p');
                    error.className = 'rut-error';
                    error.style.color = 'var(--primary-red)';
                    error.style.fontSize = '13px';
                    error.style.marginTop = '4px';
                    error.textContent = 'RUT inválido';
                    e.target.parentElement.appendChild(error);
                }
            } else {
                e.target.style.borderColor = '';
                const errorMsg = e.target.parentElement.querySelector('.rut-error');
                if (errorMsg) errorMsg.remove();
            }
        });
    }

    // Validar coincidencia de contraseñas
    {% if is_new %}
    const password1 = document.getElementById('{{ form.password1.id_for_label }}');
    const password2 = document.getElementById('{{ form.password2.id_for_label }}');
    {% else %}
    const password1 = document.getElementById('{{ form.nueva_password.id_for_label }}');
    const password2 = document.getElementById('{{ form.confirmar_password.id_for_label }}');
    {% endif %}

    if (password1 && password2) {
        password2.addEventListener('input', function() {
            if (password1.value && password2.value) {
                if (password1.value !== password2.value) {
                    password2.style.borderColor = 'var(--primary-red)';
                } else {
                    password2.style.borderColor = 'var(--primary-green)';
                }
            }
        });
    }

    // Mostrar indicador de fortaleza de contraseña
    if (password1) {
        password1.addEventListener('input', function() {
            const password = this.value;
            const strengthIndicator = this.parentElement.querySelector('.password-strength');
            
            if (password.length === 0) {
                if (strengthIndicator) strengthIndicator.remove();
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            let strengthText = '';
            let strengthColor = '';
            
            if (strength < 2) {
                strengthText = 'Débil';
                strengthColor = '#ef4444';
            } else if (strength < 4) {
                strengthText = 'Media';
                strengthColor = '#f59e0b';
            } else {
                strengthText = 'Fuerte';
                strengthColor = '#10b981';
            }

            if (!strengthIndicator) {
                const indicator = document.createElement('p');
                indicator.className = 'password-strength';
                indicator.style.fontSize = '13px';
                indicator.style.marginTop = '4px';
                this.parentElement.appendChild(indicator);
            }

            const indicator = this.parentElement.querySelector('.password-strength');
            indicator.textContent = `Fortaleza: ${strengthText}`;
            indicator.style.color = strengthColor;
        });
    }
});

// Función para validar RUT chileno
function validarRUT(rut) {
    const rutLimpio = rut.replace(/[.-]/g, '').toLowerCase();
    
    if (rutLimpio.length < 8) return false;
    
    const cuerpo = rutLimpio.slice(0, -1);
    const dv = rutLimpio.slice(-1);
    
    if (!/^\d+$/.test(cuerpo)) return false;
    
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo[i]) * multiplo;
        multiplo = multiplo === 7 ? 2 : multiplo + 1;
    }
    
    const dvEsperado = 11 - (suma % 11);
    const dvFinal = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'k' : dvEsperado.toString();
    
    return dv === dvFinal;
}

// Prevenir envío duplicado del formulario
const form = document.querySelector('form');
if (form) {
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Guardando...';
        
        // Re-habilitar después de 3 segundos por si hay error de validación
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = document.querySelector('form').dataset.originalText || 'Guardar';
        }, 3000);
    });
}
</script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spin {
    animation: spin 1s linear infinite;
}

.form-input[readonly] {
    background-color: var(--gray-100);
    cursor: not-allowed;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}
{% endblock %}