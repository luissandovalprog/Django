{% extends 'base.html' %} {% load static %} {% block title %}Gestión de
Usuarios{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auditoria.css' %}" />
<style>
  .btn-icon {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>
{% endblock %} {% block content %}
<div class="dashboard-container">
  <div class="card" style="margin-bottom: 24px">
    <div
      style="display: flex; justify-content: space-between; align-items: center"
    >
      <div>
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; color: var(--primary-blue)"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
          Gestión de Usuarios
        </h2>
        <p style="color: var(--gray-600); font-size: 14px">
          Administración de cuentas y asignación de roles según RBAC
        </p>
      </div>
      <div style="display: flex; gap: 12px">
        <a href="{% url 'accounts:rol_list' %}" class="btn btn-secondary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
          </svg>
          Gestionar Roles
        </a>
        <a href="{% url 'accounts:crear_usuario' %}" class="btn btn-primary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          Nuevo Usuario
        </a>
      </div>
    </div>

    <!-- Estadísticas de usuarios -->
    <div class="stats-grid" style="margin-bottom: 24px">
      <div class="stat-card">
        <div class="stat-content">
          <h3>Total Usuarios</h3>
          <p>{{ usuarios|length }}</p>
          <span style="font-size: 13px; color: var(--gray-500)"
            >En el sistema</span
          >
        </div>
        <div class="stat-icon blue">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <h3>Usuarios Activos</h3>
          <p>{{ usuarios_activos }}</p>
          <span style="font-size: 13px; color: var(--gray-500)"
            >Cuentas habilitadas</span
          >
        </div>
        <div class="stat-icon green">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
            <polyline points="22 4 12 14.01 9 11.01" />
          </svg>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <h3>Roles Asignados</h3>
          <p>{{ total_roles }}</p>
          <span style="font-size: 13px; color: var(--gray-500)"
            >Diferentes perfiles</span
          >
        </div>
        <div class="stat-icon purple">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
          </svg>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-content">
          <h3>Usuarios Inactivos</h3>
          <p>{{ usuarios_inactivos }}</p>
          <span style="font-size: 13px; color: var(--gray-500)"
            >Cuentas deshabilitadas</span
          >
        </div>
        <div class="stat-icon" style="background: #fee2e2; color: #991b1b">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card">
      <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          style="vertical-align: middle; color: var(--primary-blue)"
        >
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <line x1="23" y1="11" x2="23" y2="11" />
          <line x1="17" y1="11" x2="23" y2="11" />
        </svg>
        Lista de Usuarios del Sistema
      </h3>

      {% if usuarios %}
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Nombre Completo</th>
              <th>Usuario</th>
              <th>RUT</th>
              <th>Rol</th>
              <th>Email</th>
              <th>Estado</th>
              <th>Fecha Creación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for usuario in usuarios %}
            <tr>
              <td style="font-weight: 600">{{ usuario.nombre_completo }}</td>
              <td>
                <span style="font-family: monospace; color: var(--gray-700)">
                  @{{ usuario.username }}
                </span>
              </td>
              <td style="font-size: 13px">{{ usuario.rut }}</td>
              <td>
                {% if usuario.rol %}
                <span
                  class="badge"
                  style="
                                {% if usuario.rol.nombre == 'Médico' or usuario.rol.nombre == 'Matrona Clínica' %}
                                    background: #dbeafe; color: #1e40af;
                                {% elif usuario.rol.nombre == 'Enfermera' %}
                                    background: #d1fae5; color: #065f46;
                                {% elif usuario.rol.nombre == 'Supervisor' %}
                                    background: #fef3c7; color: #92400e;
                                {% elif usuario.rol.nombre == 'Admin Sistema' %}
                                    background: #e0e7ff; color: #4338ca;
                                {% else %}
                                    background: #f3f4f6; color: #374151;
                                {% endif %}
                            "
                >
                  {{ usuario.rol.nombre }}
                </span>
                {% else %}
                <span class="badge badge-gray">Sin Rol</span>
                {% endif %}
              </td>
              <td style="font-size: 13px">{{ usuario.email }}</td>
              <td>
                {% if usuario.activo %}
                <span
                  class="badge"
                  style="background: #10b981; color: white; font-weight: 600"
                >
                  ✓ Activo
                </span>
                {% else %}
                <span
                  class="badge"
                  style="background: #ef4444; color: white; font-weight: 600"
                >
                  ✕ Inactivo
                </span>
                {% endif %}
              </td>
              <td style="font-size: 13px; color: var(--gray-600)">
                {{ usuario.fecha_creacion|date:"d/m/Y" }}
              </td>
              <td>
                <div style="display: flex; gap: 8px">
                  <a
                    href="{% url 'accounts:editar_usuario' usuario.pk %}"
                    class="btn-icon"
                    style="background: #3b82f6; color: white"
                    title="Editar usuario"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                      />
                    </svg>
                  </a>
                  {% if usuario.activo %}
                  <button
                    onclick="confirmarDesactivar('{{ usuario.pk }}', '{{ usuario.username }}')"
                    class="btn-icon"
                    style="background: #ef4444; color: white"
                    title="Desactivar usuario"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
                    </svg>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div
        style="text-align: center; padding: 60px 20px; color: var(--gray-500)"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="64"
          height="64"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          style="margin-bottom: 16px; opacity: 0.3"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
        <p style="font-size: 16px; font-weight: 500">
          No hay usuarios registrados en el sistema
        </p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Form oculto para desactivar usuarios -->
  <form id="form-desactivar" method="post" action="" style="display: none">
    {% csrf_token %}
    <input type="hidden" name="accion" value="desactivar" />
  </form>

  <script>
    function confirmarDesactivar(usuarioId, username) {
      if (
        confirm(
          `¿Está seguro de desactivar al usuario @${username}?\n\nEsta acción impedirá que el usuario acceda al sistema.`
        )
      ) {
        const form = document.getElementById("form-desactivar");
        form.action = `/accounts/gestion/${usuarioId}/desactivar/`;
        form.submit();
      }
    }
  </script>
  {% endblock %}
</div>
