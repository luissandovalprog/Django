{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Gestión{% endblock %} - SIGN</title>
    

    <!-- HTMX para interacciones dinámicas sin recarga -->

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
    <link rel="stylesheet" href="{% static 'css/htmx.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated %}
    <!-- Overlay para cerrar dropdown -->
    <div id="notifications-overlay" class="notifications-overlay"></div>
    
    <nav class="navbar" style="z-index: 1000;">
    <div class="navbar-container">
        <div class="navbar-left">
            
            <button class="navbar-toggle" aria-label="Menú" id="navbar-toggle">
                ☰
            </button>
            
            <div class="navbar-brand">
                <div class="brand-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
                        <path d="M27.4,13.3c-1-3.2-3.4-5.8-6.4-7.2c-0.4-1.4-1.2-2.6-2.4-3.6c-0.4-0.3-1.1-0.3-1.4,0.2c-0.3,0.4-0.3,1.1,0.2,1.4 c2,1.6,2.6,4.4,1.4,6.7c-1,2-3.5,2.7-5.5,1.7c-1.5-0.8-2.1-2.6-1.3-4.1c0.3-0.5,0.7-0.9,1.3-1.1c0.6-0.2,1.2-0.1,1.7,0.2 c0.4,0.2,0.7,0.5,0.8,0.9c0.1,0.4,0.1,0.8-0.1,1.2c-0.3,0.5-0.1,1.1,0.4,1.4c0.5,0.3,1.1,0.1,1.4-0.4c0.4-0.8,0.5-1.8,0.3-2.7 s-0.9-1.7-1.8-2.1c-1-0.5-2.2-0.6-3.2-0.3c-0.4,0.1-0.8,0.3-1.1,0.6c-3.3,1.3-5.8,4-6.9,7.4C3.1,13.8,2,15.3,2,17 c0,1.7,1.1,3.2,2.6,3.8C6.2,25.6,10.8,29,16,29s9.8-3.4,11.4-8.3c1.5-0.6,2.6-2.1,2.6-3.8C30,15.3,28.9,13.8,27.4,13.3z M12,16 c0-0.6,0.4-1,1-1s1,0.4,1,1v2c0,0.6-0.4,1-1,1s-1-0.4-1-1V16z M15,26c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3S16.7,26,15,26z M20,18 c0,0.6-0.4,1-1,1s-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1V18z"/>
                    </svg>
                </div>
                <div class="brand-text">
                    <h1>Sistema de Gestión Neonatal</h1>
                    <p>{{ user.rol.nombre }} - {{ user.nombre_completo }} | Turno: Diurno</p>
                </div>
            </div>

            <div class="navbar-menu" id="navbar-menu">
                <a href="{% url 'core:dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Inicio
                </a>

                {% if user.puede_crear_admision_madre %}
                <a href="{% url 'core:madre_create' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Nueva Admisión
                </a>
                {% endif %}

                {% if user.puede_generar_reportes_rem %}
                <a href="{% url 'reportes:menu' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="9"/><rect x="14" y="5" width="3" height="14"/></svg>
                    Reportes
                </a>
                {% endif %}

                {% if user.puede_crear_editar_epicrisis %}
                <a href="{% url 'core:epicrisis_list' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Epicrisis
                </a>
                {% endif %}

                {% if user.puede_crear_editar_partograma %}
                <a href="{% url 'core:partograma_list' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Partograma
                </a>
                {% endif %}

                {% if user.puede_ver_auditoria %}
                <a href="{% url 'auditoria:historial_auditoria' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Auditoría
                </a>
                {% endif %}
                
                {% if user.puede_gestionar_usuarios %}
                <a href="{% url 'accounts:gestion_usuarios' %}" class="nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Gestión Usuarios
                </a>
                {% endif %}
            </div>
        </div>

        <div class="navbar-right" style="display: flex; align-items: center; gap: 12px;">
            <!-- Widget de Notificaciones -->
            <div class="notifications-wrapper">
                <button id="notifications-bell" class="notifications-bell" aria-label="Notificaciones">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notifications-badge" class="notifications-badge hidden">0</span>
                </button>

                <!-- Dropdown de Notificaciones -->
                <div id="notifications-dropdown" class="notifications-dropdown">
                    <div class="notifications-header">
                        <h3>Notificaciones</h3>
                        <button id="btn-mark-all-read" class="btn-mark-all-read" type="button">
                            Marcar todas como leídas
                        </button>
                    </div>
                    
                    <div id="notifications-list" class="notifications-list">
                        <!-- Las notificaciones se cargan dinámicamente aquí -->
                    </div>
                </div>
            </div>

            <!-- Botón Cerrar Sesión -->
            <a href="{% url 'accounts:logout' %}" class="btn-logout">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>
</nav>
    {% endif %}

    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                {% if message.tags == 'success' %}
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
                {% else %}
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
                {% endif %}
            </svg>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/notifications.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('navbar-toggle');
            const navbarMenu = document.getElementById('navbar-menu');
            
            if (toggleBtn && navbarMenu) {
                // Toggle menú
                toggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                    
                    // Cambiar icono
                    this.textContent = this.classList.contains('active') ? '✕' : '☰';
                });
                
                // Cerrar menú al hacer click en un enlace
                const navLinks = navbarMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        toggleBtn.classList.remove('active');
                        navbarMenu.classList.remove('active');
                        toggleBtn.textContent = '☰';
                    });
                });
                
                // Cerrar al hacer click fuera
                document.addEventListener('click', function(e) {
                    if (!toggleBtn.contains(e.target) && !navbarMenu.contains(e.target)) {
                        toggleBtn.classList.remove('active');
                        navbarMenu.classList.remove('active');
                        toggleBtn.textContent = '☰';
                    }
                });
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}

    <!-- Botón Flotante de Configuración 2FA -->
    {% if request.user.is_authenticated %}
    <a href="{% url 'accounts:menu_2fa' %}" class="fab-2fa" title="Configuración 2FA">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
        </svg>
    </a>

    <style>
    .fab-2fa {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
        text-decoration: none;
    }

    .fab-2fa:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        color: white;
        text-decoration: none;
    }

    .fab-2fa svg {
        animation: rotate-slow 4s linear infinite;
    }

    .fab-2fa:hover svg {
        animation: rotate-fast 0.6s linear infinite;
    }

    @keyframes rotate-slow {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes rotate-fast {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .fab-2fa {
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
        }

        .fab-2fa svg {
            width: 20px;
            height: 20px;
        }
    }
    </style>
    {% endif %}
</body>
</html>